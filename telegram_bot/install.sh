#!/bin/bash

#############################################
#  VK Teams Export Bot - Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°
#############################################

set -e  # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

# Ğ¦Ğ²ĞµÑ‚Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     VK Teams Export Bot - Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${YELLOW}ğŸ“ Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $SCRIPT_DIR${NC}\n"

#############################################
# 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python
#############################################
echo -e "${BLUE}[1/5] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Python...${NC}"

if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version 2>&1 | cut -d' ' -f2)
    echo -e "${GREEN}âœ“ Python $PYTHON_VERSION Ğ½Ğ°Ğ¹Ğ´ĞµĞ½${NC}"
else
    echo -e "${RED}âœ— Python3 Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!${NC}"
    echo ""
    echo "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Python:"
    echo "  Ubuntu/Debian: sudo apt install python3 python3-pip python3-venv"
    echo "  macOS:         brew install python3"
    echo "  Windows:       https://python.org/downloads/"
    exit 1
fi

#############################################
# 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
#############################################
echo -e "\n${BLUE}[2/5] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ...${NC}"

if [ ! -d "venv" ]; then
    python3 -m venv venv
    echo -e "${GREEN}âœ“ Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾${NC}"
else
    echo -e "${YELLOW}â€¢ Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚${NC}"
fi

# ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ venv
source venv/bin/activate

#############################################
# 3. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
#############################################
echo -e "\n${BLUE}[3/5] Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...${NC}"

pip install --upgrade pip -q
pip install -r requirements.txt -q

echo -e "${GREEN}âœ“ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹${NC}"

#############################################
# 4. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½Ğ°
#############################################
echo -e "\n${BLUE}[4/5] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½Ğ° Telegram Ğ±Ğ¾Ñ‚Ğ°...${NC}"

if [ -f ".env" ]; then
    echo -e "${YELLOW}â€¢ Ğ¤Ğ°Ğ¹Ğ» .env ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚${NC}"
    read -p "ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ? (y/N): " overwrite
    if [ "$overwrite" != "y" ] && [ "$overwrite" != "Y" ]; then
        echo "ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ Ñ‚Ğ¾ĞºĞµĞ½Ğ°"
    else
        rm .env
    fi
fi

if [ ! -f ".env" ]; then
    echo ""
    echo -e "${YELLOW}ĞšĞ°Ğº Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½:${NC}"
    echo "1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ @BotFather Ğ² Telegram"
    echo "2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ /newbot"
    echo "3. Ğ’Ğ²ĞµĞ´Ğ¸ Ğ¸Ğ¼Ñ Ğ¸ username Ğ±Ğ¾Ñ‚Ğ°"
    echo "4. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ğ¾ĞºĞµĞ½"
    echo ""
    read -p "Ğ’ÑÑ‚Ğ°Ğ²ÑŒ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°: " BOT_TOKEN

    if [ -z "$BOT_TOKEN" ]; then
        echo -e "${RED}âœ— Ğ¢Ğ¾ĞºĞµĞ½ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½!${NC}"
        echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ñ„Ğ°Ğ¹Ğ» .env Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:"
        echo "  echo 'TG_BOT_TOKEN=Ñ‚Ğ²Ğ¾Ğ¹_Ñ‚Ğ¾ĞºĞµĞ½' > .env"
        exit 1
    fi

    echo "TG_BOT_TOKEN=$BOT_TOKEN" > .env
    echo -e "${GREEN}âœ“ Ğ¢Ğ¾ĞºĞµĞ½ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½ Ğ² .env${NC}"
fi

#############################################
# 5. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
#############################################
echo -e "\n${BLUE}[5/5] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°...${NC}"

cat > run.sh << 'EOF'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"
source venv/bin/activate
python bot.py
EOF

chmod +x run.sh

echo -e "${GREEN}âœ“ Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ run.sh ÑĞ¾Ğ·Ğ´Ğ°Ğ½${NC}"

#############################################
# Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!
#############################################
echo ""
echo -e "${GREEN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘            âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo ""
echo -e "Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°:"
echo -e "  ${YELLOW}./run.sh${NC}"
echo ""
echo -e "Ğ˜Ğ»Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:"
echo -e "  ${YELLOW}source venv/bin/activate${NC}"
echo -e "  ${YELLOW}python bot.py${NC}"
echo ""
echo -e "ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°: ${YELLOW}Ctrl+C${NC}"
echo ""

#############################################
# Ğ¡Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞº
#############################################
read -p "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ? (Y/n): " run_now

if [ "$run_now" != "n" ] && [ "$run_now" != "N" ]; then
    echo ""
    echo -e "${BLUE}ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Ğ±Ğ¾Ñ‚Ğ°...${NC}"
    echo -e "${YELLOW}ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°: Ctrl+C${NC}"
    echo ""
    python bot.py
fi
